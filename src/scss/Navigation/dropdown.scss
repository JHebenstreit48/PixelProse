@use 'sass:color';
@use '@scss/Globals' as *;

/* =========================================================
   Local tokens
   ========================================================= */
$dd-bg: $dropdown-bg;
$dd-bg-nested: rgba(14, 14, 24, 0.78);
$dd-sep: $nav-glass-border;
$dd-hover: $dropdown-hover;

$dd-offset-y: 6px;
$chev-size: 0.95rem;

/* =========================================================
   Level palette (no fallbacks needed; defined in Colors.scss)
   ========================================================= */
$nav-l2: $level-2;
$nav-l3: $level-3;
$nav-l4: $level-4;
$nav-l5: $level-5;
$nav-l6: $level-6;
$nav-l7: $level-7;

/* =========================================================
   Shared level treatment: consistent ladder
   ========================================================= */
@mixin nav-level($c, $size, $weight, $borderAlpha, $bgTop, $bgBot) {
  color: $c;
  font-size: $size;
  font-weight: $weight;
  letter-spacing: 0.12px;
  text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.72);

  border-top: 1px solid color.change($c, $alpha: $borderAlpha);

  background: linear-gradient(to bottom, rgba(255, 255, 255, $bgTop) 0%, rgba(0, 0, 0, $bgBot) 100%);
}

/* =========================================================
   Dropdown Button
   ========================================================= */
.dropdownButton {
  display: flex;
  position: relative;
  flex-direction: column;

  background-color: transparent;
  border: none;
  cursor: pointer;

  color: $nav-level-1-brand;
  font: inherit;
  line-height: 1.2;

  text-align: center;
  text-decoration: none;
  text-shadow: $nav-text-shadow-dim;

  width: 100%;
  box-sizing: border-box;

  align-items: center;
  justify-content: center;

  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  hyphens: auto;

  padding-block: 0.3rem;
  padding-inline: 0.55rem;

  appearance: none;
  -webkit-appearance: none;

  &:hover {
    background-color: $dd-hover;
    text-decoration: none;
  }

  &:focus-visible {
    outline: 2px solid rgba(0, 255, 255, 0.7);
    outline-offset: 2px;
    border-radius: 8px;
  }

  /* Level ladder */
  &.level-1 {
    color: $nav-level-1-brand;
    font-size: $font-lg;
    font-weight: 700;
    margin: 0 auto;
    padding: 0;
    letter-spacing: 0.3px;
    border-top: 0;
    background: none;
    text-shadow: $nav-text-shadow-dim;
  }

  &.level-2 {
    @include nav-level($nav-l2, 1.06rem, 760, 0.18, 0.08, 0.18);
  }
  &.level-3 {
    @include nav-level($nav-l3, 1.03rem, 700, 0.12, 0.03, 0.14);
  }
  &.level-4 {
    @include nav-level($nav-l4, 0.99rem, 650, 0.1, 0.02, 0.12);
  }
  &.level-5 {
    @include nav-level($nav-l5, 0.95rem, 610, 0.1, 0.02, 0.12);
  }

  &.level-6 {
    @include nav-level($nav-l6, 0.91rem, 590, 0.16, 0.02, 0.14);
    opacity: 0.98;
  }
  &.level-7 {
    @include nav-level($nav-l7, 0.88rem, 540, 0.08, 0.02, 0.14);
    opacity: 0.92;
  }

  .level-1,
  .level-2,
  .level-3,
  .level-4,
  .level-5,
  .level-6,
  .level-7 {
    display: flex;
    flex-direction: column;
    text-align: center;
    margin: 0 auto;
    justify-content: center;
  }

  @include maxw($cellphone-portrait) {
    font-size: 1.05rem;
    padding: 0.4rem;
    gap: $nav-gap-mobile;

    &.level-2 {
      font-size: 1.04rem;
    }
    &.level-3 {
      font-size: 1.01rem;
    }
    &.level-4 {
      font-size: 0.97rem;
    }
    &.level-5 {
      font-size: 0.93rem;
    }
    &.level-6 {
      font-size: 0.9rem;
    }
    &.level-7 {
      font-size: 0.88rem;
    }
  }
  @include between($small-laptop-min, $small-laptop-max) {
    font-size: 1.25rem;
  }
  @include between($medium-laptop-min, $medium-laptop-max) {
    font-size: 1.35rem;
  }
  @include between($large-laptop-min, $large-laptop-max) {
    font-size: 1.4rem;
  }
}

/* Links vs buttons */
.dropdownItem a.dropdownButton {
  font-weight: 600;
}
.dropdownItem button.dropdownButton {
  font-weight: 700;
}

/* Force level colors for BOTH <a> and <button> */
.dropdownItem :is(a, button).dropdownButton {
  &.level-1 {
    color: $nav-level-1-brand;
  }
  &.level-2 {
    color: $nav-l2;
  }
  &.level-3 {
    color: $nav-l3;
  }
  &.level-4 {
    color: $nav-l4;
  }
  &.level-5 {
    color: $nav-l5;
  }
  &.level-6 {
    color: $nav-l6;
  }
  &.level-7 {
    color: $nav-l7;
  }
}

/* =========================================================
   Dropdown layout
   ========================================================= */
.dropdown {
  position: relative;
  display: inline-block;
  text-align: center;
  margin: 0;
  overflow: visible;

  @include maxw($cellphone-portrait) {
    display: block;
    width: 100%;
    margin: 0 auto;
  }
}

/* separators */
.dropdownItem {
  width: 100%;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}
.dropdownItem:last-child {
  border-bottom: none;
}
.dropdownContent .dropdownItem:first-child .dropdownButton {
  border-top: 0;
}

/* =========================================================
   Dropdown menu content (glass)
   ========================================================= */
.dropdownContent {
  position: absolute;

  left: 50%;
  transform: translateX(-50%);
  top: calc(100% + #{$dd-offset-y});

  width: auto;
  min-width: 12rem;
  max-width: min(18rem, calc(100vw - 2rem));

  background: linear-gradient(180deg, $nav-glass-sheen-top, $nav-glass-sheen-bot), $dd-bg;

  backdrop-filter: blur($nav-glass-blur) saturate(140%);
  -webkit-backdrop-filter: blur($nav-glass-blur) saturate(140%);

  border: 1px solid $dd-sep;
  border-radius: $dropdown-radius;

  box-shadow:
    0 18px 60px rgba(0, 0, 0, 0.62),
    0 0 22px rgba(0, 255, 255, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);

  text-align: center;

  isolation: isolate;
  display: none;
  z-index: $z-nav-dropdown;

  transition:
    box-shadow 140ms ease,
    background-color 140ms ease;

  &.active {
    display: grid;
    grid-template-columns: 1fr;
    justify-items: stretch;
    align-items: stretch;
    row-gap: 0.12rem;

    max-height: $nav-dropdown-max-height;
    overflow-y: auto;

    padding: 0;

    scrollbar-width: thin;
    scrollbar-color: $dropdown-hover $scrollbar-track;

    &::-webkit-scrollbar {
      width: $scrollbar-width-thin;
    }
    &::-webkit-scrollbar-thumb {
      background: $dropdown-hover;
      border-radius: $dropdown-radius;
      &:hover {
        background: color.adjust($dropdown-hover, $lightness: 10%);
      }
    }
    &::-webkit-scrollbar-track {
      background: transparent;
    }
    &::-webkit-scrollbar-button {
      display: none;
    }

    @include maxw($cellphone-portrait) {
      position: static;
      transform: none;
      background: linear-gradient(180deg, $nav-glass-sheen-top, $nav-glass-sheen-bot), $dd-bg;

      backdrop-filter: blur($nav-glass-blur) saturate(140%);
      -webkit-backdrop-filter: blur($nav-glass-blur) saturate(140%);

      box-shadow: none;
      padding: 0;
      margin-top: $nav-dropdown-mobile-margin-top;
      width: 100%;
      border-radius: 0;
    }
  }
}

/* nested menu background */
.dropdownMenu.active {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01)), $dd-bg-nested;
}

/* =========================================================
   Chevron trick (center label)
   ========================================================= */
button.dropdownButton.level-1 {
  display: inline-flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
}

button.dropdownButton.level-1::before {
  content: '';
  display: inline-block;
  width: $chev-size;
  height: 1px;
}

button.dropdownButton.level-1::after {
  content: '▾';
  display: inline-block;
  width: $chev-size;
  text-align: center;
  line-height: 1;
  opacity: 0.9;
}

button.dropdownButton.level-1.active::after {
  content: '▴';
}

.dropdownItem a.dropdownButton::before,
.dropdownItem a.dropdownButton::after {
  content: none;
  display: none;
}

/* open accent line */
button.dropdownButton.active {
  box-shadow:
    inset 2px 0 0 $nav-glass-rim,
    inset 0 -1px 0 rgba(0, 0, 0, 0.55);
}

/* reduced motion */
@media (prefers-reduced-motion: reduce) {
  button.dropdownButton.level-1::after {
    transition: none;
  }
}